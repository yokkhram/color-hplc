<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé® Real-Time Color Sensor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, background-color: #111; color: #fff; text-align: center; margin: 0; padding: 20px; }
  h1 { margin-bottom: 10px; }
  .color-box { width: 160px; height: 160px; border-radius: 10px; border: 2px solid #555; margin: 15px auto 5px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #000; transition: background-color 0.3s ease; }
  #colorHex { font-size: 16px; color: #ccc; margin-bottom: 10px; }
  .chart-container { width: 95%; max-width: 800px; height: 220px; background-color: #222; border: 2px solid #444; border-radius: 10px; margin: 10px auto; padding: 10px; }
  canvas { width: 100%; height: 100%; }
  button { margin: 6px; padding: 8px 18px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
  button:hover { opacity: 0.8; }
  .btn-reset { background-color: #555; color: #fff; }
  .btn-cal { background-color: #1e90ff; color: #fff; }
  #log { max-width:800px; margin: 10px auto; color:#ddd; text-align:left; font-size:13px; height:120px; overflow:auto; background:#0b0b0b; padding:8px; border-radius:6px; border:1px solid #222; }
</style>
</head>
<body>
  <h1>üé® Real-Time Color Sensor</h1>
  <div class="color-box" id="colorBox">#000000</div>
  <div id="colorHex">#000000</div>
  <button class="btn-reset" onclick="resetData()">üîÑ Reset</button>
  <button class="btn-cal" onclick="calibrateWhite()">üìè Calibrate White</button>

  <div class="chart-container"><canvas id="chart"></canvas></div>

  <div id="log"></div>

<script>
function addLog(msg){
  const el = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  el.innerHTML = `[${t}] ${msg}<br>` + el.innerHTML;
}

let chart;
function setupChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Red', borderColor: 'red', data: [], fill: false, tension: 0.1 },
        { label: 'Green', borderColor: 'lime', data: [], fill: false, tension: 0.1 },
        { label: 'Blue', borderColor: 'blue', data: [], fill: false, tension: 0.1 },
        { label: 'Yellow', borderColor: 'yellow', data: [], fill: false, tension: 0.1 }
      ]
    },
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, max: 255, ticks: { color: "#ccc" } },
        x: { ticks: { color: "#aaa" } }
      },
      plugins: { legend: { labels: { color: "#ddd" } } }
    }
  });
}

function updateColorBox(r,g,b) {
  const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`.toUpperCase();
  const box = document.getElementById('colorBox');
  box.style.backgroundColor = `rgb(${r},${g},${b})`;
  document.getElementById('colorHex').textContent = hex;
  const brightness = (r*299 + g*587 + b*114)/1000;
  box.style.color = brightness > 125 ? '#000' : '#fff';
}

function addData(r,g,b) {
  const t = new Date().toLocaleTimeString().split(':')[2];
  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(r);
  chart.data.datasets[1].data.push(g);
  chart.data.datasets[2].data.push(b);
  chart.data.datasets[3].data.push(Math.min(r+g,255));
  if (chart.data.labels.length > 30) {
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds => ds.data.shift());
  }
  updateColorBox(r,g,b);
  chart.update();
}

function resetData(){
  chart.data.labels = [];
  chart.data.datasets.forEach(ds => ds.data = []);
  updateColorBox(0,0,0);
  chart.update();
  addLog("Reset data");
}

async function calibrateWhite(){
  try{
    const res = await fetch("/api/calibrate", { method: "POST" });
    const j = await res.json();
    addLog(j.message || "Calibrate sent");
    alert("üì° Calibrate command sent!");
  }catch(err){
    addLog("Calibrate error: " + err);
    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á calibrate ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏î‡∏π‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•");
  }
}

setupChart();

const evtSource = new EventSource("/events");
evtSource.onmessage = (event) => {
  try {
    const data = JSON.parse(event.data);
    if (typeof data.r === 'number') {
      addData(data.r, data.g, data.b);
    }
  } catch (err) {
    addLog("SSE parse error: " + err);
  }
};
evtSource.onerror = (e) => {
  addLog("SSE error, trying to reconnect...");
};
</script>
</body>
</html>
